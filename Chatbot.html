<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickSecure - Asistente de Emergencias</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para el scroll y el contenedor principal */
        #chat-window {
            overflow-y: auto;
            /* Estilo para la barra de desplazamiento */
            scrollbar-width: none; /* Firefox */
        }
        #chat-window::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }

        /* Estilos de los mensajes */
        .message {
            max-width: 80%;
            word-wrap: break-word;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.75rem; /* rounded-xl */
        }

        .bot-message {
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem; /* rounded-bl-sm */
            background-color: #e0f7fa; /* teal-50 equivalente */
            color: #00796b; /* teal-800 equivalente */
        }

        .user-message {
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem; /* rounded-br-sm */
            background-color: #d1fae5; /* green-100 equivalente */
            color: #10b981; /* green-500 equivalente */
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="chatbot-container" class="w-full max-w-lg h-[90vh] md:h-[70vh] bg-white shadow-2xl rounded-2xl flex flex-col overflow-hidden">
        
        <!-- Encabezado de la App -->
        <header class="bg-red-600 text-white p-4 flex items-center justify-between shadow-md">
            <div class="flex items-center space-x-3">
                <span class="text-2xl font-bold">QuickSecure</span>
                <span class="text-sm font-light">Asistente de Emergencias</span>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        </header>

        <!-- Ventana del Chat -->
        <div id="chat-window" class="flex-grow p-4 space-y-2 flex flex-col">
            <!-- Los mensajes del chat se insertar√°n aqu√≠ -->
        </div>

        <!-- √Årea de Entrada -->
        <div id="input-area" class="p-4 bg-gray-50 border-t border-gray-200 flex space-x-3">
            <input type="text" id="user-input" placeholder="Cu√©ntanos tu emergencia..." autocomplete="off" 
                   class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-red-500 text-gray-800 disabled:bg-gray-200">
            <button id="send-btn" 
                    class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                Enviar
            </button>
        </div>

    </div>

    <script>
        // --- L√ìGICA DEL CHATBOT (Python a JavaScript) ---

        // Variables base (Mensajes traducidos)
        const mensajeInicial = (
            "Hola, soy tu asistente de emergencias de QuickSecure.\n"
            + "Estoy aqu√≠ contigo. Por favor, cu√©ntame lo que est√° pasando."
        );

        const mensajeConfirmacion = (
            "Gracias por informarme.\n"
            + "üö® Ya estoy notificando a las entidades de emergencia correspondientes.\n"
            + "üõ∞Ô∏è Tenemos tu ubicaci√≥n en todo momento y los equipos est√°n en camino.\n"
            + "Mant√©n la calma, no est√°s solo/a. Estoy contigo hasta que lleguen."
        );

        const mensajeDespedida = (
            "‚úÖ La comunicaci√≥n se ha cerrado.\n"
            + "Si necesitas ayuda nuevamente, solo vuelve a escribirme.\n"
        );

        // Lista de despedidas comunes
        const despedidas = [
            "adios","adi√≥s","bye","chao","chau","hasta luego","nos vemos","me voy",
            "hasta pronto","hasta ma√±ana","cuidate","cu√≠date","hasta la pr√≥xima",
            "ok","okei","okay","vale","listo","dale","bueno","ya fue","gracias",
            "estoy bien","todo bien","no m√°s","gracias bot","terminar","salir","ya"
        ];

        // Elementos del DOM
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        // Estado de la ubicaci√≥n (Simulaci√≥n)
        let ubicacion = { lat: null, lon: null };

        // --- Funciones de Utilidad ---

        /**
         * Limpia el texto (equivalente a limpiar_texto en Python).
         * Elimina puntuaci√≥n y convierte a min√∫sculas, manejando caracteres especiales espa√±oles.
         * @param {string} texto - Texto de entrada.
         * @returns {string} - Texto limpio y en min√∫sculas.
         */
        function limpiarTexto(texto) {
            if (!texto) {
                return "";
            }
            let textoLimpio = texto.toLowerCase();
            // Reemplaza todo lo que no sea letra (a-z, √°√©√≠√≥√∫√±), n√∫mero (\d), o espacio (\s) por un espacio.
            textoLimpio = textoLimpio.replace(/[^\w\s√°√©√≠√≥√∫√±]/g, ' ').trim();
            // Elimina m√∫ltiples espacios
            textoLimpio = textoLimpio.replace(/\s+/g, ' '); 
            return textoLimpio;
        }

        /**
         * Funci√≥n principal del bot (equivalente a responder en Python).
         * @param {string} texto - Mensaje del usuario.
         * @param {number|null} lat - Latitud.
         * @param {number|null} lon - Longitud.
         * @returns {string} - Respuesta del chatbot.
         */
        function responder(texto, lat = null, lon = null) {
            const textoLimpio = limpiarTexto(texto);

            // 1. Verificaci√≥n de despedidas
            if (despedidas.some(p => textoLimpio.includes(p))) {
                return mensajeDespedida;
            } 
            // 2. Verificaci√≥n de mensaje vac√≠o (o solo espacios)
            else if (textoLimpio === "") {
                // Esta l√≥gica se usa principalmente si el usuario pulsa Enter en un campo vac√≠o
                // y el c√≥digo de Python lo espera. En el front-end es m√°s com√∫n prevenir el env√≠o.
                return mensajeInicial;
            } 
            // 3. Respuesta de emergencia (el coraz√≥n del bot)
            else {
                if (lat !== null && lon !== null) {
                    // La ubicaci√≥n se formatea a 4 decimales
                    return (mensajeConfirmacion 
                            + `\nüìç Recibimos tu ubicaci√≥n: lat ${lat.toFixed(4)}, lon ${lon.toFixed(4)}.`);
                } else {
                    return mensajeConfirmacion;
                }
            }
        }

        /**
         * Renderiza un mensaje en la ventana del chat.
         * @param {string} texto - El contenido del mensaje.
         * @param {string} remitente - 'bot' o 'user'.
         */
        function agregarMensaje(texto, remitente) {
            const mensajeDiv = document.createElement('div');
            mensajeDiv.classList.add('message', `${remitente}-message`);
            // Reemplaza \n por <br> para saltos de l√≠nea en HTML
            mensajeDiv.innerHTML = texto.replace(/\n/g, '<br>'); 
            chatWindow.appendChild(mensajeDiv);
            // Hace scroll autom√°tico al final
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }


        // --- Manejadores de Eventos y L√≥gica de Flujo ---

        /**
         * Procesa la interacci√≥n del usuario.
         */
        function procesarMensaje() {
            const textoUsuario = userInput.value.trim();
            
            // Ignorar si el campo est√° vac√≠o o el chat est√° cerrado
            if (textoUsuario === '' || userInput.disabled) {
                return;
            }

            // 1. Mostrar mensaje del usuario y limpiar campo
            agregarMensaje(textoUsuario, 'user');
            userInput.value = '';

            // 2. Deshabilitar entrada temporalmente
            userInput.disabled = true;
            sendBtn.disabled = true;

            // 3. Obtener respuesta del bot (simulando un tiempo de respuesta)
            const lat = ubicacion.lat;
            const lon = ubicacion.lon;
            
            const respuestaBot = responder(textoUsuario, lat, lon);

            setTimeout(() => {
                // Habilitar entrada
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();

                agregarMensaje(respuestaBot, 'bot');
                
                // Cerrar chat si el mensaje es de despedida
                if (respuestaBot === mensajeDespedida) {
                    userInput.disabled = true;
                    sendBtn.disabled = true;
                    userInput.placeholder = "Comunicaci√≥n cerrada. Recarga para ayuda de nuevo.";
                }
            }, 700); // Retraso de 700ms
        }

        /**
         * Intenta obtener la ubicaci√≥n real del usuario.
         */
        function obtenerUbicacion() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // Ubicaci√≥n obtenida
                        ubicacion.lat = position.coords.latitude;
                        ubicacion.lon = position.coords.longitude;
                        console.log("Ubicaci√≥n obtenida:", ubicacion);
                        // No notificamos al usuario para no saturar, solo la usamos si es una emergencia.
                    },
                    (error) => {
                        // Error o denegaci√≥n de ubicaci√≥n (simulaci√≥n de fallo)
                        ubicacion.lat = 4.7110; // Ubicaci√≥n por defecto de ejemplo
                        ubicacion.lon = -74.0721;
                        console.error("Error al obtener ubicaci√≥n. Usando ubicaci√≥n por defecto.", error.message);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                // Navegador no soporta Geolocalizaci√≥n
                ubicacion.lat = 4.7110;
                ubicacion.lon = -74.0721;
                console.warn("Geolocalizaci√≥n no soportada por el navegador. Usando ubicaci√≥n por defecto.");
            }
        }


        // Asignaci√≥n de Eventos al cargar la p√°gina
        window.onload = () => {
            // Intentar obtener la ubicaci√≥n real (o usar la de ejemplo)
            obtenerUbicacion();

            // Mensaje de bienvenida del bot
            agregarMensaje(mensajeInicial, 'bot');

            // Escuchar click en el bot√≥n
            sendBtn.addEventListener('click', procesarMensaje);

            // Escuchar tecla Enter en el campo de texto
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !userInput.disabled) {
                    procesarMensaje();
                }
            });
            
            userInput.focus();
        };
    </script>
</body>
</html>
