<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickSecure - Asistente de Emergencias</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ========================================= */
        /* 1. DEFINICI√ìN DE VARIABLES Y COLORES BASE */
        /* ========================================= */
        :root {
            /* Colores de tu estilo (Bot/Respuesta) - V√çVIDO */
            --accent-2: #33d4ff; /* Cian Brillante */
            /* Colores de tu estilo (Usuario/Env√≠a) - V√çVIDO */
            --accent: #ff4d4d;    /* Rojo-Coral Brillante */
            
            /* Colores de Tema Oscuro de QuickSecure */
            --bg1: #1a1a2e; /* Fondo principal oscuro */
            --bg2: #0f0f1d; /* Fondo de contenedor de chat m√°s oscuro */
            --text-light: #eaf6ff;
            --text-muted: rgba(234, 246, 255, 0.7);

            /* Radios de borde */
            --radius: 12px;

            /* Colores de Prioridad (Ajustados para ser m√°s intensos) */
            --color-critical: #cc0000; /* Rojo Cr√≠tico m√°s profundo */
            --color-medium: #ffdd57;
            --color-low: #48c74; /* Verde */
        }

        /* Aplicaci√≥n del tema oscuro al cuerpo */
        body {
            background-color: var(--bg1);
            color: var(--text-light);
            /* FUENTE CONSISTENTE: Aplicada a todo el body para herencia uniforme */
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s;
        }

        /* Estilo de la cabecera */
        .app-header {
            background-color: var(--bg2);
            border-bottom: 2px solid var(--accent-2);
        }

        /* ========================================= */
        /* 2. ESTILOS DE CHAT (VIBRANTES) */
        /* ========================================= */

        /* Chat container - Aplicado a #chat-window */
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius);
            padding: 1rem;
            background: var(--bg2); 
            display: flex; 
            flex-direction: column;
        }

        /* Contenedor del Chatbot principal */
        #chatbot-container {
            background-color: var(--bg2);
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }
        
        /* Estilos base del mensaje - USO DEL MISMO FONT-WEIGHT PARA UNIFORMIDAD */
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: var(--radius);
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4); 
            animation: slideIn 0.3s ease-out;
            line-height: 1.4;
            font-weight: 500; /* Peso est√°ndar para legibilidad en Dark Mode */
            /* Contorno sutil en todo el texto del mensaje */
            text-shadow: 0 0 1px rgba(0,0,0,0.2); 
        }

        /* Mensaje del usuario (Remitente) - GRADIENTE ROJO INTENSO */
        .message.user {
            background: linear-gradient(135deg, var(--accent), #ff7b7b); 
            color: white;
            margin-left: auto;
            align-self: flex-end; 
            text-align: right;
            border-bottom-right-radius: 4px; 
        }

        /* Mensaje del bot (Operador/Respuesta) - GRADIENTE AZUL CONSISTENTE */
        .message.bot {
            background: linear-gradient(135deg, #0099ff, var(--accent-2)); 
            color: white; 
            align-self: flex-start; 
            border-bottom-left-radius: 4px; 
        }
        
        /* Mensaje de sistema (sin cambios) */
        .message.system {
            background: rgba(255,255,255,0.1);
            color: var(--text-muted);
            text-align: center;
            max-width: 100%;
            font-style: italic;
            border: 1px solid rgba(255,255,255,0.1);
            align-self: center;
        }

        /* Contorno para Negrita (√©nfasis) - PESO 700 EST√ÅNDAR */
        .message-content strong {
            font-weight: 700; 
            /* Sombra fuerte para hacer que el texto resalte */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); 
        }

        /* √Årea de input */
        #input-area {
            background-color: var(--bg2);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        #user-input {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-light);
            transition: border-color 0.3s;
        }

        #user-input::placeholder {
            color: var(--text-muted);
        }

        /* Contorno del campo de texto a color rojo del usuario */
        #user-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 77, 77, 0.5);
        }

        /* Bot√≥n de env√≠o a color rojo del usuario */
        #send-btn {
            background: linear-gradient(45deg, var(--accent), #ff7b7b);
            color: var(--bg1);
            box-shadow: 0 4px 15px rgba(255, 77, 77, 0.4);
        }
        #send-btn:hover {
            background: linear-gradient(45deg, #ff7b7b, var(--accent));
            box-shadow: 0 6px 20px rgba(255, 77, 77, 0.6);
        }

        /* Scrollbar personalizado (sin cambios) */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--accent-2);
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* ========================================= */
        /* 3. ESTILOS DE PRIORIDAD (SOLO EFECTOS)    */
        /* ========================================= */

        /* Animaci√≥n de Pulso (CR√çTICA) - M√ÅS R√ÅPIDA */
        @keyframes pulse-text {
            0% { text-shadow: 0 0 1px var(--color-critical); }
            50% { text-shadow: 0 0 8px var(--color-critical), 0 0 4px var(--accent); }
            100% { text-shadow: 0 0 1px var(--color-critical); }
        }

        /* Animaci√≥n de entrada de mensajes (sin cambios) */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilo para Fuego/M√©dico (CR√çTICO) - SOLO EFECTO VISUAL, NO FONT-WEIGHT */
        .emergency-priority-critical {
            color: white !important;
            /* Se elimina font-weight: 700; */
            animation: pulse-text 1.2s infinite; 
            text-shadow: 0 0 3px var(--color-critical); 
        }
        
        /* Estilo para Polic√≠a (ALTA) - SOLO EFECTO VISUAL, NO FONT-WEIGHT */
        .emergency-priority-high {
            color: white !important;
            /* Se elimina font-weight: 600; */
        }

        /* Estilo para Tr√°nsito (MEDIA) - SOLO EFECTO VISUAL, NO FONT-WEIGHT */
        .emergency-priority-medium {
            color: white !important; 
            /* Se elimina font-weight: 500; */
        }

        /* Estilo para Saludo/Despedida (BAJA) - SOLO EFECTO VISUAL, NO FONT-WEIGHT */
        .emergency-priority-low {
            color: white !important;
            /* Se elimina font-weight: 400; */
        }

    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="chatbot-container" class="w-full max-w-lg h-[90vh] md:h-[70vh] shadow-2xl rounded-2xl flex flex-col overflow-hidden">
        
        <!-- Encabezado de la App -->
        <header class="app-header text-white p-4 flex items-center justify-between shadow-lg">
            <div class="flex items-center space-x-3">
                <span class="text-2xl font-bold">QuickSecure</span>
                <span class="text-sm font-light text-gray-300">Asistente de Emergencias</span>
            </div>
            <!-- Icono de Advertencia/Emergencia (Tri√°ngulo titilando) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-8 w-8 fill-red-600 animate-pulse">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" fill="#dc2626"/> <!-- Rojo intenso -->
                <line x1="12" y1="9" x2="12" y2="13" stroke="#fef08a"/> <!-- Amarillo claro (Signo !) -->
                <line x1="12" y1="17" x2="12.01" y2="17" stroke="#fef08a"/> <!-- Amarillo claro (Punto) -->
            </svg>
        </header>

        <!-- Ventana del Chat - CLASE APLICADA chat-container -->
        <div id="chat-window" class="chat-container flex-grow space-y-2">
            <!-- Los mensajes del chat se insertar√°n aqu√≠ -->
        </div>

        <!-- √Årea de Entrada -->
        <div id="input-area" class="p-4 flex space-x-3">
            <input type="text" id="user-input" placeholder="Cu√©ntanos tu emergencia..." autocomplete="off" 
                   class="flex-grow p-3 rounded-full focus:outline-none focus:ring-2 disabled:bg-gray-700">
            <button id="send-btn" 
                    class="font-semibold py-3 px-6 rounded-full shadow-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                Enviar
            </button>
        </div>

    </div>

    <script>
        // --- L√ìGICA DEL CHATBOT ---

        // Variables base (Mensajes traducidos)
        const mensajeInicial = (
            "Hola, soy tu asistente de emergencias de QuickSecure.\n"
            + "Estoy aqu√≠ contigo. Por favor, cu√©ntame lo que est√° pasando."
        );

        // CAMBIO: Ahora solo se aplica negrita a las partes importantes
        const mensajeConfirmacion = (
            "Gracias por informarme.\n"
            + "üö® Ya estoy **notificando a las entidades de emergencia** correspondientes.\n"
            + "üõ∞Ô∏è Tenemos tu ubicaci√≥n en todo momento y los **equipos est√°n en camino**.\n"
            + "Mant√©n la calma, no est√°s solo/a. Estoy contigo hasta que lleguen."
        );

        const mensajeDespedida = (
            "‚úÖ La comunicaci√≥n se ha cerrado.\n"
            + "Si necesitas ayuda nuevamente, solo vuelve a escribirme.\n"
        );
        
        // MENSAJES Y LISTAS DE CLASIFICACI√ìN
        const mensajeSaludo = "¬°Hola! Entiendo que tienes una emergencia. Por favor, **s√© lo m√°s espec√≠fico posible** sobre lo que est√° ocurriendo (ej: robo, fuego, me siento mal) para que pueda enviar la ayuda correcta.";

        // Lista de despedidas comunes
        const despedidas = [
            "adios","adi√≥s","bye","chao","chau","hasta luego","nos vemos","me voy",
            "hasta pronto","hasta ma√±ana","cuidate","cu√≠date","hasta la pr√≥xima",
            "ok","okei","okay","vale","listo","dale","bueno","ya fue","gracias",
            "estoy bien","todo bien","no m√°s","gracias bot","terminar","salir","ya"
        ];
        
        // Lista de saludos simples
        const saludos = ["hola", "buenos dias", "buenas tardes", "buenas noches", "que tal", "hello", "hi"];

        // Categor√≠as de emergencia (keywords) - LISTAS EXPANDIDAS
        
        // Palabras clave para Polic√≠a / Seguridad Ciudadana (PRIORIDAD ALTA - emergency-priority-high)
        const emergenciasPoliciales = [
            "robo", "atraco", "asalto", "violencia", "mataron", "disparo", "secuestro", 
            "pelea", "delito", "sospechoso", "ladron", "policia", "asesinato", "agresion", 
            "vandalismo", "allanamiento", "extorsion", "amenaza", "pandilla", "banda", 
            "arma", "captura", "crimen", "escape", "fugitivo", "detener", "hurto", 
            "ofensa", "disturbio", "seguridad", "carcel", "juez", "denuncia", "asalto"
        ];
        
        // Palabras clave para Bomberos / Rescate (PRIORIDAD CR√çTICA - emergency-priority-critical)
        const emergenciasBomberos = [
            "fuego", "incendio", "quemando", "humo", "escape de gas", "atrapado", 
            "inundacion", "derrumbe", "explosi√≥n", "bomberos", "rescate", "quimico", 
            "estructura", "peligro", "llamas", "colapso", "derramamiento", "gases", 
            "cortocircuito", "tormenta", "desastre", "sismo", "terremoto", "colgado", 
            "altura", "rescate animal", "goteando", "tuber√≠a", "cable", "arbol caido", "rescatar"
        ];
        
        // Palabras clave para Ambulancias / Emergencias M√©dicas (PRIORIDAD CR√çTICA - emergency-priority-critical)
        const emergenciasMedicas = [
            "accidente", "herido", "enfermo", "infarto", "paro cardiaco", "desmayo", 
            "ambulancia", "medico", "caida", "sangre", "urgencia", "golpe", "fractura", 
            "convulsiones", "ayuda medica", "hemorragia", "asfixia", "dolor", "epilepsia", 
            "parto", "intoxicacion", "veneno", "aplastamiento", "fiebre", "desvanecimiento", 
            "vomito", "respirar", "quemadura", "critico", "desangrando", "pestilencia", "mal olor", 
            "desnutrici√≥n", "mareo", "consciencia", "desmayarse"
        ];
        
        // Palabras clave para Tr√°nsito / Accidentes Viales (PRIORIDAD MEDIA - emergency-priority-medium)
        const emergenciasTransito = [
            "accidente de transito", "choque", "via bloqueada", "sem√°foro", "atropello", 
            "transito", "carretera", "bloqueo", "vehiculo", "carro", "moto", "coche", 
            "automovil", "congestion", "deslizamiento", "puente", "cruce", "patrulla", 
            "averia", "paralizado", "cierre vial", "muro", "despiste", "frenos", "bus", "camion", 
            "trafico", "vial", "conductor"
        ];
        
        // Elementos del DOM
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        // Estado de la ubicaci√≥n (Simulaci√≥n)
        let ubicacion = { lat: null, lon: null };

        // --- Funciones de Utilidad ---

        /**
         * Limpia el texto para el an√°lisis de palabras clave.
         */
        function limpiarTexto(texto) {
            if (!texto) {
                return "";
            }
            let textoLimpio = texto.toLowerCase();
            // Permite solo letras, n√∫meros y espacios
            textoLimpio = textoLimpio.replace(/[^\w\s√°√©√≠√≥√∫√±]/g, ' ').trim();
            textoLimpio = textoLimpio.replace(/\s+/g, ' '); 
            return textoLimpio;
        }
        
        /**
         * Determina la respuesta contextual y la CLASE DE ESTILO DE PRIORIDAD.
         * @returns {{respuesta: string|null, clase: string|null}} - Objeto con la respuesta y la clase CSS.
         */
        function getContextualResponse(textoLimpio) {
            let respuesta = null;
            let clase = null;

            // Prioridad 1: Bomberos / Rescate (CR√çTICA)
            if (emergenciasBomberos.some(p => textoLimpio.includes(p))) {
                respuesta = "üî• **EMERGENCIA:** Emergencia de **Fuego/Rescate** detectada. Ya hemos notificado a los **Bomberos**. Por favor, ind√≠canos si hay heridos o personas atrapadas y la direcci√≥n del viento.";
                clase = 'emergency-priority-critical';
            }
            // Prioridad 2: M√©dica / Sanitaria (CR√çTICA)
            else if (emergenciasMedicas.some(p => textoLimpio.includes(p))) {
                respuesta = "üöë **URGENTE:** Emergencia **M√©dica/Sanitaria** detectada. Ya hemos solicitado una **Ambulancia**. Por favor, dinos el estado de conciencia de la persona afectada y su edad aproximada.";
                clase = 'emergency-priority-critical';
            }
            // Prioridad 3: Polic√≠a / Seguridad Ciudadana (ALTA)
            else if (emergenciasPoliciales.some(p => textoLimpio.includes(p))) {
                respuesta = "üëÆ **ALARMA:** Emergencia de **Seguridad Ciudadana** detectada. Ya hemos notificado a la **Polic√≠a**. Por favor, describe la situaci√≥n y la apariencia de los involucrados.";
                clase = 'emergency-priority-high';
            }
            // Prioridad 4: Tr√°nsito / Vial (MEDIA)
            else if (emergenciasTransito.some(p => textoLimpio.includes(p))) {
                respuesta = "üö® **ATENCI√ìN:** Emergencia de **Tr√°nsito/Vial** detectada. Ya hemos notificado a las autoridades de **Tr√°nsito**. Indica si hay heridos, si el tr√°fico est√° completamente bloqueado, o si hay un derrame de combustible.";
                clase = 'emergency-priority-medium';
            }
            
            return { respuesta, clase };
        }


        /**
         * Funci√≥n principal del bot.
         */
        function responder(texto, lat = null, lon = null) {
            const textoLimpio = limpiarTexto(texto);
            const { respuesta, clase } = getContextualResponse(textoLimpio);

            let respuestaFinal = null;
            let claseFinal = null;

            // 1. Verificaci√≥n de despedidas
            if (despedidas.some(p => textoLimpio.includes(p))) {
                respuestaFinal = mensajeDespedida;
                claseFinal = 'emergency-priority-low';
            } 
            // 2. Verificaci√≥n de mensaje vac√≠o
            else if (textoLimpio === "") {
                respuestaFinal = mensajeInicial;
                claseFinal = 'bot'; // Por defecto, usa el color azul/cian
            } 
            // 3. Verificaci√≥n de saludos simples
            else if (saludos.some(p => textoLimpio === p) || saludos.some(p => textoLimpio.startsWith(p + " ") && textoLimpio.length < p.length + 15)) {
                respuestaFinal = mensajeSaludo;
                claseFinal = 'emergency-priority-low';
            }
            // 4. Procesamiento de emergencia (Clasificada)
            else if (respuesta) {
                // Generar confirmaci√≥n con ubicaci√≥n
                let fullConfirmation = mensajeConfirmacion;
                if (lat !== null && lon !== null) {
                    fullConfirmation += `\nüìç Recibimos tu ubicaci√≥n: lat ${lat.toFixed(4)}, lon ${lon.toFixed(4)}.`;
                }
                
                respuestaFinal = respuesta + "\n\n---\n" + fullConfirmation;
                claseFinal = clase; // Usa la clase de prioridad obtenida
            }
            // 5. Default: Confirmaci√≥n gen√©rica (No clasificada, pero es una emergencia)
            else {
                let fullConfirmation = mensajeConfirmacion;
                if (lat !== null && lon !== null) {
                    fullConfirmation += `\nüìç Recibimos tu ubicaci√≥n: lat ${lat.toFixed(4)}, lon ${lon.toFixed(4)}.`;
                }
                respuestaFinal = fullConfirmation;
                claseFinal = 'emergency-priority-high'; // Usar High como gen√©rico de emergencia
            }

            return { respuesta: respuestaFinal, clase: claseFinal };
        }

        /**
         * Renderiza un mensaje en la ventana del chat con su clase de estilo.
         */
        function agregarMensaje(texto, remitente, claseAdicional = null) {
            const mensajeDiv = document.createElement('div');
            
            // La clase base ahora es 'user' o 'bot' para aplicar los gradientes definidos
            let claseBase = remitente === 'bot' ? 'bot' : 'user';
            
            mensajeDiv.classList.add('message', claseBase);
            
            // Si es un bot y tiene una clase de prioridad, la a√±ade (esto sobrescribir√° el estilo de .message.bot)
            if (remitente === 'bot' && claseAdicional) {
                mensajeDiv.classList.add(claseAdicional);
            }

            // Usamos innerHTML para permitir negritas y saltos de l√≠nea
            mensajeDiv.innerHTML = `<div class="message-content">${texto.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>`; 
            
            chatWindow.appendChild(mensajeDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }


        // --- Manejadores de Eventos y L√≥gica de Flujo ---

        /**
         * Procesa la interacci√≥n del usuario.
         */
        function procesarMensaje() {
            const textoUsuario = userInput.value.trim();
            
            if (textoUsuario === '' || userInput.disabled) {
                return;
            }

            // 1. Mostrar mensaje del usuario y limpiar campo
            agregarMensaje(textoUsuario, 'user');
            userInput.value = '';

            // 2. Deshabilitar entrada temporalmente
            userInput.disabled = true;
            sendBtn.disabled = true;

            // 3. Obtener respuesta del bot (simulando un tiempo de respuesta)
            const lat = ubicacion.lat;
            const lon = ubicacion.lon;
            
            const { respuesta: respuestaBot, clase: claseBot } = responder(textoUsuario, lat, lon);

            setTimeout(() => {
                // Habilitar entrada
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();

                agregarMensaje(respuestaBot, 'bot', claseBot);
                
                // Cerrar chat si el mensaje es de despedida
                if (respuestaBot === mensajeDespedida) {
                    userInput.disabled = true;
                    sendBtn.disabled = true;
                    userInput.placeholder = "Comunicaci√≥n cerrada. Recarga para ayuda de nuevo.";
                }
            }, 700); // Retraso de 700ms
        }

        /**
         * Fija la ubicaci√≥n simulada.
         */
        function obtenerUbicacion() {
            // Ubicaci√≥n por defecto de ejemplo: Bogot√°
            ubicacion.lat = 4.7110; 
            ubicacion.lon = -74.0721;
            console.warn("Geolocalizaci√≥n real bloqueada. Usando ubicaci√≥n de ejemplo para QuickSecure.");
        }


        // Asignaci√≥n de Eventos al cargar la p√°gina
        window.onload = () => {
            obtenerUbicacion();
            agregarMensaje(mensajeInicial, 'bot');

            sendBtn.addEventListener('click', procesarMensaje);
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !userInput.disabled) {
                    procesarMensaje();
                }
            });
            
            userInput.focus();
        };
    </script>
</body>
</html>
